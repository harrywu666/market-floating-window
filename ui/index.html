<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gold Monitor</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="glass-card" id="main-container">
        <!-- 拖动手柄 -->
        <div class="drag-handle"></div>

        <div class="header">
            <span class="title">贵金属价格监控</span>
            <div class="status-dot tooltip" id="status-dot">
                <span class="tooltiptext">实时更新中</span>
            </div>
        </div>

        <div class="content">
            <!-- 黄金区块 -->
            <div class="price-section" id="section-gold">
                <div class="section-title">黄金 (XAU)</div>
                <div class="price-group">
                    <div class="price-row">
                        <div class="label-group">
                            <span class="label">国际 (USD/oz)</span>
                            <span class="change" id="gold-intl-change">--</span>
                        </div>
                        <div class="price" id="gold-intl-price">--</div>
                    </div>
                    <div class="price-row">
                        <div class="label-group">
                            <span class="label">国内 (CNY/g)</span>
                            <span class="change" id="gold-dom-change">--</span>
                        </div>
                        <div class="price" id="gold-dom-price">--</div>
                    </div>
                </div>
                <div class="section-divider"></div>
            </div>

            <!-- 白银区块 -->
            <div class="price-section" id="section-silver">
                <div class="section-title">白银 (XAG)</div>
                <div class="price-group">
                    <div class="price-row">
                        <div class="label-group">
                            <span class="label">国际 (USD/oz)</span>
                            <span class="change" id="silver-intl-change">--</span>
                        </div>
                        <div class="price" id="silver-intl-price">--</div>
                    </div>
                    <div class="price-row">
                        <div class="label-group">
                            <span class="label">国内 (CNY/g)</span>
                            <span class="change" id="silver-dom-change">--</span>
                        </div>
                        <div class="price" id="silver-dom-price">--</div>
                    </div>
                </div>
                <div class="section-divider"></div>
            </div>

            <!-- 加密货币区块 -->
            <div class="price-section" id="section-crypto">
                <div class="section-title">数字资产 (Crypto)</div>
                <div class="price-group" id="crypto-list">
                    <!-- BTC, ETH, SOL, BNB 将在这里动态生成或更新 -->
                </div>
            </div>
        </div>

        <div class="footer">
            <span class="rate">汇率: <span id="exchange-rate">0.0000</span></span>
            <span class="time" id="update-time">--:--:--</span>
        </div>
    </div>

    <script>
        // 存储控制
        const defaultConfig = {
            "gold": true, "silver": true, "crypto": true,
            "BTC": true, "ETH": true, "SOL": true, "BNB": true
        };
        // 健壮加载：合并默认配置与存储配置
        let stored = {};
        try { stored = JSON.parse(localStorage.getItem('gold_monitor_v4') || '{}'); } catch (e) { }
        const config = { ...defaultConfig, ...stored };

        const cryptoOrder = ['BTC', 'ETH', 'BNB', 'SOL'];

        function toggleSection(name) {
            config[name] = !config[name];
            localStorage.setItem('gold_monitor_v4', JSON.stringify(config));
            applyConfig();
        }

        function applyConfig() {
            ['gold', 'silver', 'crypto'].forEach(key => {
                const el = document.getElementById('section-' + key);
                if (el) el.classList.toggle('hidden', !config[key]);
            });
            updateCryptoStyles();
        }

        function updateCryptoStyles() {
            cryptoOrder.forEach(symbol => {
                const el = document.getElementById('crypto-' + symbol);
                if (el) el.classList.toggle('hidden', !config[symbol]);
            });
        }
        function setSolidMode(isSolid) {
            const container = document.getElementById('main-container');
            if (container) container.classList.toggle('solid', isSolid);
        }
        applyConfig();

        function updateUI(data) {
            if (data.error) console.warn("Fetch Error:", data.error);

            if (config.gold && data.gold) {
                updateRow('gold-intl', data.gold.intl, data.gold.intl_change, 2);
                updateRow('gold-dom', data.gold.dom, data.gold.dom_change, 2);
            }
            if (config.silver && data.silver) {
                updateRow('silver-intl', data.silver.intl, data.silver.intl_change, 2);
                updateRow('silver-dom', data.silver.dom, data.silver.dom_change, 2);
            }
            if (config.crypto && data.crypto) {
                updateCrypto(data.crypto);
            }

            if (data.exchange_rate) {
                document.getElementById('exchange-rate').innerText = data.exchange_rate.toFixed(4);
            }
            document.getElementById('update-time').innerText = new Date().toLocaleTimeString('zh-CN', { hour12: false });
        }

        function updateCrypto(cryptos) {
            const list = document.getElementById('crypto-list');
            cryptoOrder.forEach(symbol => {
                if (!cryptos[symbol]) return;

                let row = document.getElementById('crypto-' + symbol);
                if (!row) {
                    row = document.createElement('div');
                    row.className = 'price-row';
                    row.id = 'crypto-' + symbol;
                    row.innerHTML = `<div class="label-group"><span class="label">${symbol}</span><span class="change">--</span></div><div class="price">--</div>`;
                    list.appendChild(row);
                }

                row.classList.toggle('hidden', !config[symbol]);

                const priceEl = row.querySelector('.price');
                const changeEl = row.querySelector('.change');
                const pVal = cryptos[symbol].price;
                const cVal = cryptos[symbol].change;

                if (pVal > 0) {
                    const pText = pVal > 1000 ? pVal.toFixed(2) : pVal.toFixed(pVal > 10 ? 2 : 4);
                    if (priceEl.innerText !== pText) priceEl.innerText = pText;

                    const trendClass = cVal >= 0 ? 'up' : 'down';
                    changeEl.innerText = (cVal >= 0 ? '+' : '') + cVal.toFixed(2) + '%';
                    changeEl.className = 'change ' + trendClass;
                    priceEl.className = 'price ' + trendClass;
                }
            });
        }

        function updateRow(idPrefix, price, change, precision) {
            const priceEl = document.getElementById(idPrefix + '-price');
            const changeEl = document.getElementById(idPrefix + '-change');
            if (priceEl && changeEl) {
                const oldPrice = priceEl.innerText;
                const priceValue = parseFloat(price) || 0;
                const newPrice = priceValue.toFixed(precision);

                if (oldPrice !== newPrice) {
                    priceEl.innerText = newPrice;
                }

                const trendClass = change >= 0 ? 'up' : 'down';
                changeEl.innerText = (change >= 0 ? '+' : '') + parseFloat(change || 0).toFixed(2) + '%';
                changeEl.className = 'change ' + trendClass;
                priceEl.className = 'price ' + trendClass;
            }
        }

        function triggerUpdateFlash(change) {
            const container = document.getElementById('main-container');
            container.style.boxShadow = '0 15px 40px rgba(0, 0, 0, 0.6)';
        }
    </script>
</body>

</html>